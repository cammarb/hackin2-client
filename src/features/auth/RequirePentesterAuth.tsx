import { useNavigate, Outlet, useLocation } from 'react-router-dom'
import { useSelector } from 'react-redux'
import { selectCurrentRole, selectCurrentUser } from '@/features/auth/authSlice'
import { useToast } from '@/components/ui/use-toast'
import { useEffect } from 'react'
import Forbidden from '@/pages/Error/403'

const RequirePentesterAuth = () => {
  const user = useSelector(selectCurrentUser)
  const role = useSelector(selectCurrentRole)
  const navigate = useNavigate()
  const location = useLocation()

  const { toast } = useToast()

  // biome-ignore lint/correctness/useExhaustiveDependencies: This will run once when the component loads
  useEffect(() => {
    if (!user || !role) {
      toast({
        title: 'Uh oh! Something went wrong.',
        description: 'There was a problem with your request.'
      })
      navigate('/login', { state: { from: location }, replace: true })
    }
  }, [])

  if (user && role === 'PENTESTER') {
    return <Outlet />
  }
  if ((user && role !== 'PENTESTER') || !user || !role) {
    return <Forbidden />
  }
  return <></>
}

export default RequirePentesterAuth
